<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Firebase Realtime Database Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f4f6f8; --card:#fff; --ink:#333; --muted:#6b7280; --brand:#007bff;
      --ring:#e5e7eb; --ring-strong:#d1d5db;
    }
    *{box-sizing:border-box}
    body { font-family: Arial, sans-serif; margin: 0; background: var(--bg); color: var(--ink); }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    /* --- Topbar with Statistics button --- */
    .topbar{
      position: sticky; top:0; z-index: 30;
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--ring);
    }
    .topbar-inner{
      max-width: 1400px; margin: 0 auto; padding: 12px 20px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      font-weight: 800; letter-spacing:.2px; font-size: 18px; color:#111827;
    }
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      background: var(--brand); color:#fff; padding:10px 14px;
      border: none; border-radius: 10px; cursor: pointer; text-decoration: none;
      font-weight: 600; box-shadow: 0 6px 16px rgba(0,123,255,.18);
    }
    .btn:focus,.btn:hover{filter: brightness(0.95)}
    .btn.secondary{
      background:#111827; box-shadow: 0 6px 16px rgba(17,24,39,.15);
    }

    /* --- Headings & cards --- */
    h1 { margin: 14px 0 18px; font-size: 22px; color:#111827; }
    h2 { margin-top: 24px; color: #111827; font-size:16px }
    .card{
      background: var(--card); border:1px solid var(--ring);
      border-radius: 14px; padding: 16px; margin: 18px 0;
      box-shadow: 0 8px 24px rgba(0,0,0,.05);
    }

    /* --- Tables --- */
    table { border-collapse: collapse; width: 100%; background: white; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; font-size: 14px; }
    thead th { background: #f8fafc; color: #374151; position: sticky; top: 0; z-index: 1; }
    tr:nth-child(even) td { background: #fafafa; }
    .table-wrap{overflow:auto; border:1px solid var(--ring); border-radius: 12px}

    /* Responsive tweaks */
    @media (max-width: 640px){
      .brand{font-size:16px}
      .btn{padding:9px 12px}
      h1{font-size:20px}
    }
  </style>
</head>
<body>

  <!-- Top navigation with Statistics button -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">Firebase Realtime Database Viewer</div>
      <div class="actions">
        <!-- Link to your statistics page -->
        <a class="btn" href="statistics.html" aria-label="Go to statistics page">
          <!-- tiny chart icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M5 3v18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 17V9m5 8V5m5 13v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Statistics
        </a>
      </div>
    </div>
  </div>

  <div class="container">
    <h1>Overview</h1>

    <div class="card">
      <h2>Water Usage</h2>
      <div class="table-wrap">
        <table id="selectedSessionsTable">
          <thead>
            <tr>
              <th>Email</th><th>UID</th><th>Username</th><th>Line No</th>
              <th>Card ID</th><th>Reader</th><th>Total Time (s)</th><th>Water Used (ml)</th>
              <th>Total Bill (Tk)</th><th>Remaining Balance</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>Users</h2>
      <div class="table-wrap">
        <table id="usersTable">
          <thead><tr id="usersHead"></tr></thead>
          <tbody id="usersBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>Device Logs (B8:D6:1A:68:2A:28)</h2>
      <div class="table-wrap">
        <table id="deviceLogsTable">
          <thead>
            <tr><th>Device ID</th><th>Log ID</th><th>Message</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>Device Sessions (B8:D6:1A:68:2A:28)</h2>
      <div class="table-wrap">
        <table id="deviceSessionsTable">
          <thead>
            <tr>
              <th>Device ID</th><th>Session ID</th><th>Card ID</th><th>Reader</th>
              <th>Total Time (s)</th><th>Water Used (ml)</th><th>Total Bill (Tk)</th><th>Remaining Balance</th>
              <th>Email</th><th>Line No</th><th>UID</th><th>Username</th>
              <th>Start Time</th><th>End Time</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ================= BACKEND (unchanged) ================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDTa2HCvoXWkQRhkTxIHTlPFL7WqlWP_WQ",
      authDomain: "trial-a8077.firebaseapp.com",
      databaseURL: "https://trial-a8077-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "trial-a8077",
      storageBucket: "trial-a8077.firebasestorage.app",
      messagingSenderId: "903998363888",
      appId: "1:903998363888:web:44a853e7652ba7b3f14a35"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // === Utility: flatten object ===
    function flatten(obj, prefix='') {
      const result = {};
      for (const k in obj) {
        if (typeof obj[k] === 'object' && obj[k] !== null) {
          Object.assign(result, flatten(obj[k], prefix + k + '.'));
        } else {
          result[prefix + k] = obj[k];
        }
      }
      return result;
    }

    // === Utility: render dynamic table ===
    function renderTable(tableHeadId, tableBodyId, data) {
      const headRow = document.getElementById(tableHeadId);
      const body = document.getElementById(tableBodyId);
      headRow.innerHTML = "";
      body.innerHTML = "";
      if (!data) return;

      const rows = Object.values(data).map(row => flatten(row));
      const allKeys = new Set();
      rows.forEach(r => Object.keys(r).forEach(k => allKeys.add(k)));

      allKeys.forEach(k => {
        const th = document.createElement("th");
        th.textContent = k;
        headRow.appendChild(th);
      });

      rows.forEach(r => {
        const tr = document.createElement("tr");
        allKeys.forEach(k => {
          const td = document.createElement("td");
          td.textContent = r[k] ?? "";
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    }

    // === Users ===
    let usersMap = {};
    onValue(ref(db, "users"), snap => {
      const data = snap.val();
      usersMap = {};
      if (data) {
        Object.keys(data).forEach(uid => {
          const user = data[uid];
          if (user.cardId) {
            usersMap[user.cardId] = {
              email: user.email || "",
              lineNo: user.lineNo || "",
              uid: uid,
              username: user.username || ""
            };
          }
        });
      }
      renderTable("usersHead", "usersBody", data);
    });

    // === Only this device ===
    const deviceId = "B8:D6:1A:68:2A:28";
    const deviceRef = ref(db, "devices/" + deviceId);
    onValue(deviceRef, (snapshot) => {
      const device = snapshot.val();
      const logsBody = document.querySelector("#deviceLogsTable tbody");
      const sessionsBody = document.querySelector("#deviceSessionsTable tbody");
      const selectedBody = document.querySelector("#selectedSessionsTable tbody");

      logsBody.innerHTML = "";
      sessionsBody.innerHTML = "";
      selectedBody.innerHTML = "";

      let allSessions = [];

      function formatTime(sec) {
        const d = new Date(sec * 1000);
        return d.toLocaleTimeString();
      }

      if (device) {
        // logs
        if (device.logs) {
          Object.keys(device.logs).forEach(logId => {
            logsBody.innerHTML += `
              <tr>
                <td>${deviceId}</td>
                <td>${logId}</td>
                <td>${device.logs[logId]}</td>
              </tr>`;
          });
        }

        // sessions
        if (device.sessions) {
          Object.keys(device.sessions).forEach(sessionId => {
            const s = device.sessions[sessionId];
            const cardId = s.cardId || "";
            const userInfo = usersMap[cardId] || {};
            const lineNo = userInfo.lineNo || "";

            const startSec = s.timestamp || 0;
            const endSec = startSec + (s.totalTimeSec || 0);

            sessionsBody.innerHTML += `
              <tr>
                <td>${deviceId}</td>
                <td>${sessionId}</td>
                <td>${cardId}</td>
                <td>${s.reader || ''}</td>
                <td>${s.totalTimeSec || ''}</td>
                <td>${s.totalUsedML || ''}</td>
                <td>${s.totalBillTk || ''}</td>
                <td>${s.remainingBalance || ''}</td>
                <td>${userInfo.email || ''}</td>
                <td>${lineNo}</td>
                <td>${userInfo.uid || ''}</td>
                <td>${userInfo.username || ''}</td>
                <td>${formatTime(startSec)}</td>
                <td>${formatTime(endSec)}</td>
              </tr>`;

            allSessions.push({
              email: userInfo.email || '',
              uid: userInfo.uid || '',
              username: userInfo.username || '',
              lineNo: lineNo,
              cardId: cardId,
              reader: s.reader || '',
              totalTimeSec: s.totalTimeSec || '',
              totalUsedML: s.totalUsedML || '',
              totalBillTk: s.totalBillTk || '',
              remainingBalance: s.remainingBalance || ''
            });
          });
        }
      }

      // শেষ Line 1 আর Line 2 show করবে
      let lastLine1 = null;
      let lastLine2 = null;
      for (let i = allSessions.length - 1; i >= 0; i--) {
        if (!lastLine2 && allSessions[i].lineNo == "2") {
          lastLine2 = allSessions[i];
        }
        if (!lastLine1 && allSessions[i].lineNo == "1") {
          lastLine1 = allSessions[i];
        }
        if (lastLine1 && lastLine2) break;
      }

      if (lastLine2) {
        selectedBody.innerHTML += `
          <tr>
            <td>${lastLine2.email}</td>
            <td>${lastLine2.uid}</td>
            <td>${lastLine2.username}</td>
            <td>${lastLine2.lineNo}</td>
            <td>${lastLine2.cardId}</td>
            <td>${lastLine2.reader}</td>
            <td>${lastLine2.totalTimeSec}</td>
            <td>${lastLine2.totalUsedML}</td>
            <td>${lastLine2.totalBillTk}</td>
            <td>${lastLine2.remainingBalance}</td>
          </tr>`;
      }
      if (lastLine1) {
        selectedBody.innerHTML += `
          <tr>
            <td>${lastLine1.email}</td>
            <td>${lastLine1.uid}</td>
            <td>${lastLine1.username}</td>
            <td>${lastLine1.lineNo}</td>
            <td>${lastLine1.cardId}</td>
            <td>${lastLine1.reader}</td>
            <td>${lastLine1.totalTimeSec}</td>
            <td>${lastLine1.totalUsedML}</td>
            <td>${lastLine1.totalBillTk}</td>
            <td>${lastLine1.remainingBalance}</td>
          </tr>`;
      }
    });
  </script>
</body>
</html>
