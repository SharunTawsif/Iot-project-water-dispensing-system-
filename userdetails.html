<!DOCTYPE html>
<html lang="en" class="h-full scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <title>User Details & Water Usage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            elevate: '0 1px 2px rgba(0,0,0,0.05), 0 8px 24px rgba(0,0,0,0.06)'
          }
        }
      }
    }
  </script>

  <!-- Chart.js for user-specific charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="h-full bg-gradient-to-br from-slate-50 to-slate-100 text-slate-900 antialiased">
  <!-- Header / Welcome -->
  <header class="sticky top-0 z-40 border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="mx-auto flex max-w-3xl items-center justify-between px-4 py-3">
      <h1 class="text-lg font-extrabold tracking-tight sm:text-xl">User Details & Water Usage</h1>
      <span class="rounded-full border border-sky-200 bg-sky-50 px-3 py-1 text-xs font-medium text-sky-700">Live</span>
    </div>
  </header>

  <main class="mx-auto max-w-3xl p-4 sm:p-6 space-y-6">
    <!-- User box -->
    <section class="rounded-2xl border border-slate-200 bg-white shadow-elevate">
      <div class="flex flex-col items-center gap-3 p-5 sm:p-6">
        <div class="grid h-14 w-14 place-items-center rounded-2xl border border-slate-200 bg-white">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-slate-800" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.34 0-8 2.24-8 5v1h16v-1c0-2.76-3.66-5-8-5Z"/>
          </svg>
        </div>
        <h2 class="text-base font-bold tracking-tight">Welcome User</h2>
        <p id="userEmail" class="text-sm text-slate-600">Loading…</p>
        <button onclick="logout()"
                class="mt-1 inline-flex items-center justify-center rounded-xl border border-rose-200 bg-rose-50 px-4 py-2.5 text-sm font-semibold text-rose-700 shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-rose-500">
          Logout
        </button>
      </div>
    </section>

    <!-- Latest Water Usage -->
    <section class="rounded-2xl border border-slate-200 bg-white shadow-elevate">
      <div class="p-5 sm:p-6">
        <h3 class="text-base font-bold tracking-tight">Latest Water Usage</h3>

        <!-- Skeleton (shown until data appears) -->
        <div id="skeleton" class="mt-4 grid grid-cols-1 gap-3 sm:grid-cols-2">
          <div class="h-10 rounded-xl bg-slate-100 animate-pulse"></div>
          <div class="h-10 rounded-xl bg-slate-100 animate-pulse"></div>
          <div class="h-10 rounded-xl bg-slate-100 animate-pulse"></div>
          <div class="h-10 rounded-xl bg-slate-100 animate-pulse"></div>
          <div class="h-10 rounded-xl bg-slate-100 animate-pulse"></div>
          <div class="h-10 rounded-xl bg-slate-100 animate-pulse"></div>
        </div>

        <div id="sessionCard" class="mt-4 hidden rounded-2xl border border-slate-200 bg-white p-4 sm:p-5">
          <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-800">Email</label>
              <input id="email" type="text" readonly
                     class="w-full cursor-default rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 text-sm shadow-sm" />
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-800">UID</label>
              <input id="uid" type="text" readonly
                     class="w-full cursor-default rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 text-sm shadow-sm" />
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-800">Username</label>
              <input id="username" type="text" readonly
                     class="w-full cursor-default rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 text-sm shadow-sm" />
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-800">Line No</label>
              <input id="lineNo" type="text" readonly
                     class="w-full cursor-default rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 text-sm shadow-sm" />
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-800">Card ID</label>
              <input id="cardId" type="text" readonly
                     class="w-full cursor-default rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 text-sm shadow-sm" />
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-800">Reader</label>
              <input id="reader" type="text" readonly
                     class="w-full cursor-default rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 text-sm shadow-sm" />
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-800">Total Time (s)</label>
              <input id="totalTimeSec" type="text" readonly
                     class="w-full cursor-default rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 text-sm shadow-sm" />
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-800">Water Used (ml)</label>
              <input id="totalUsedML" type="text" readonly
                     class="w-full cursor-default rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 text-sm shadow-sm" />
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-800">Total Bill (Tk)</label>
              <input id="totalBillTk" type="text" readonly
                     class="w-full cursor-default rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 text-sm shadow-sm" />
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-800">Remaining Balance</label>
              <input id="remainingBalance" type="text" readonly
                     class="w-full cursor-default rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 text-sm shadow-sm" />
            </div>
          </div>
        </div>

        <p id="noData" class="mt-3 hidden text-sm text-slate-600">
          No usage found yet for this account.
        </p>
      </div>
    </section>

    <!-- NEW: Your Usage per Session (bar chart) -->
    <section class="rounded-2xl border border-slate-200 bg-white shadow-elevate">
      <div class="p-5 sm:p-6">
        <h3 class="text-base font-bold tracking-tight">Your Usage per Session</h3>
        <p class="text-xs text-slate-500">Hover a bar to see session <b>Start</b> and <b>End</b> times.</p>

        <!-- Skeleton for chart -->
        <div id="chartSkeleton" class="mt-4 h-72 w-full rounded-2xl bg-slate-100 animate-pulse"></div>

        <!-- Chart canvas (nothing below it) -->
        <div class="mt-4">
          <canvas id="userBarChart" class="hidden" height="380"></canvas>
        </div>
      </div>
    </section>
  </main>

  <!-- ========= BACKEND ========= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDTa2HCvoXWkQRhkTxIHTlPFL7WqlWP_WQ",
      authDomain: "trial-a8077.firebaseapp.com",
      databaseURL: "https://trial-a8077-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "trial-a8077",
      storageBucket: "trial-a8077.firebasestorage.app",
      messagingSenderId: "903998363888",
      appId: "1:903998363888:web:44a853e7652ba7b3f14a35"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // header email
    const email = sessionStorage.getItem("userEmail");
    if (email) {
      document.getElementById("userEmail").textContent = "Logged in as: " + email;
    } else {
      document.getElementById("userEmail").textContent = "No user logged in.";
    }
    window.logout = function() {
      sessionStorage.removeItem("userEmail");
      window.location.href = "user-login.html";
    }

    // --- Helpers ---
    const isMs   = (t)=> t && t > 1e12;               // naive ms vs s detector
    const toSec  = (t)=> isMs(t) ? Math.floor(t/1000) : (t||0);
    const destroyIf = (c)=> { if (c) { try { c.destroy(); } catch(_){} } };

    // --- Users cache by cardId ---
    let usersMap = {};
    onValue(ref(db, "users"), snap => {
      const data = snap.val();
      usersMap = {};
      if (data) {
        Object.keys(data).forEach(uid => {
          const user = data[uid];
          if (user.cardId) {
            usersMap[user.cardId] = {
              email: user.email || "",
              lineNo: user.lineNo || "",
              uid: uid,
              username: user.username || ""
            };
          }
        });
      }
    });

    // Pull ALL devices, then filter sessions for current user
    let barInstance = null;

    onValue(ref(db, "devices"), (snapshot) => {
      const devices = snapshot.val();

      // 1) Build session list for the current user's email
      let sessionsForUser = [];
      if (devices) {
        Object.keys(devices).forEach(deviceId => {
          const device = devices[deviceId];
          if (!device || !device.sessions) return;

          Object.keys(device.sessions).forEach(sessionId => {
            const s = device.sessions[sessionId];
            const cardId = s.cardId || "";
            const userInfo = usersMap[cardId] || {};
            if (userInfo.email === email) {
              const startSec = toSec(s.timestamp);
              const endSec   = startSec + Number(s.totalTimeSec || 0);

              sessionsForUser.push({
                start: startSec,
                end: endSec,
                usage: Number(s.totalUsedML || 0),

                // also keep fields to fill the “Latest Water Usage” box
                uid: userInfo.uid || '',
                username: userInfo.username || '',
                lineNo: userInfo.lineNo || '',
                email: userInfo.email || '',
                cardId: cardId,
                reader: s.reader || '',
                duration: Number(s.totalTimeSec || 0),
                totalBillTk: s.totalBillTk || '',
                remainingBalance: s.remainingBalance || ''
              });
            }
          });
        });
      }

      // 2) Update “Latest Water Usage” card
      const sessionCard = document.getElementById("sessionCard");
      const skeleton    = document.getElementById("skeleton");
      const noData      = document.getElementById("noData");

      if (sessionsForUser.length > 0) {
        // sort by start time asc and pick last
        sessionsForUser.sort((a,b)=>a.start-b.start);
        const last = sessionsForUser[sessionsForUser.length - 1];

        sessionCard.classList.remove("hidden");
        skeleton.classList.add("hidden");
        noData.classList.add("hidden");

        document.getElementById("email").value            = last.email;
        document.getElementById("uid").value              = last.uid;
        document.getElementById("username").value         = last.username;
        document.getElementById("lineNo").value           = last.lineNo;
        document.getElementById("cardId").value           = last.cardId;
        document.getElementById("reader").value           = last.reader;
        document.getElementById("totalTimeSec").value     = last.duration;
        document.getElementById("totalUsedML").value      = last.usage;
        document.getElementById("totalBillTk").value      = last.totalBillTk;
        document.getElementById("remainingBalance").value = last.remainingBalance;
      } else {
        sessionCard.classList.add("hidden");
        skeleton.classList.add("hidden");
        noData.classList.remove("hidden");
      }

      // 3) Build bar chart data for this user
      const chartSkeleton = document.getElementById("chartSkeleton");
      const canvas        = document.getElementById("userBarChart");

      if (sessionsForUser.length === 0) {
        destroyIf(barInstance);
        canvas.classList.add("hidden");
        chartSkeleton.classList.add("hidden");
        // Nothing is shown below the chart section when there is no data.
        return;
      }

      // Sort and data series (labels will be hidden)
      const sorted = [...sessionsForUser].sort((a,b)=>a.start-b.start);
      const labels = new Array(sorted.length).fill(""); // no x-axis labels at all
      const dataMl = sorted.map(s => s.usage);

      // Show chart; hide skeleton
      chartSkeleton.classList.add("hidden");
      canvas.classList.remove("hidden");

      // (Re)render chart
      const ctx = canvas.getContext("2d");
      destroyIf(barInstance);
      barInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Water Used (ml)',
            data: dataMl,
            backgroundColor: '#0ea5e9cc',   // Tailwind sky-500 w/ alpha
            borderRadius: 8,
            barPercentage: 0.85,
            categoryPercentage: 0.72
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                // Build tooltip title from timestamps (since x labels are blank)
                title: (items) => {
                  const i = items[0].dataIndex;
                  const s = new Date(sorted[i].start * 1000).toLocaleString();
                  const e = new Date(sorted[i].end   * 1000).toLocaleTimeString();
                  return `Start: ${s} | End: ${e}`;
                },
                label: (ctx) => `Usage: ${ctx.parsed.y} ml`
              }
            }
          },
          scales: {
            x: {
              display: false,          // fully hide x-axis (ticks & title)
              grid: { display: false } // no grid below chart
            },
            y: { beginAtZero: true }
          }
        }
      });
    });
  </script>
</body>
</html>
